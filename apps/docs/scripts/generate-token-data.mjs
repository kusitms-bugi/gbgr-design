import fs from "node:fs"
import path from "node:path"

function parseCssVariables(cssText) {
	const tokenRegex = /--([a-zA-Z0-9-_]+)\s*:\s*([^;]+);/g
	/** @type {{name: string, value: string}[]} */
	const tokens = []
	for (const match of cssText.matchAll(tokenRegex)) {
		const name = match[1]?.trim()
		const value = match[2]?.trim()
		if (!name || !value) continue
		tokens.push({ name, value })
	}
	return tokens
}

function stableStringify(value) {
	return JSON.stringify(value, null, "\t")
}

const docsRoot = path.resolve(import.meta.dirname, "..")
const repoRoot = path.resolve(docsRoot, "..", "..")
const tokensBaseCssPath = path.resolve(
	repoRoot,
	"packages",
	"tokens",
	"dist",
	"tokens.base.css",
)
const outFilePath = path.resolve(docsRoot, "src", "generated", "tokensBase.ts")

const cssText = fs.readFileSync(tokensBaseCssPath, "utf8")
const tokens = parseCssVariables(cssText)

const outDir = path.dirname(outFilePath)
fs.mkdirSync(outDir, { recursive: true })

const content =
	`/* eslint-disable */\n` +
	`// This file is auto-generated by apps/docs/scripts/generate-token-data.mjs\n` +
	`// Source: packages/tokens/dist/tokens.base.css\n\n` +
	`export type CssToken = { name: string; value: string }\n\n` +
	`export const tokensBase: CssToken[] = ${stableStringify(tokens)} as const\n`

fs.writeFileSync(outFilePath, content, "utf8")
console.log(
	`Generated ${path.relative(repoRoot, outFilePath)} (${tokens.length} tokens)`,
)
