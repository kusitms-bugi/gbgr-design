import { promises as fs } from "node:fs"
import path from "node:path"
import { transform } from "@svgr/core"

const SRC_RAW_DIR = path.join(process.cwd(), "src", "raw")
const SRC_COMPONENTS_DIR = path.join(process.cwd(), "src", "components")
const SRC_INDEX_FILE = path.join(process.cwd(), "src", "index.ts")
const SRC_TYPES_FILE = path.join(process.cwd(), "src", "types.ts")

const GENERATED_BANNER =
	"/* This file is auto-generated by packages/icons/build/build.mjs */"

function toComponentName(svgFile) {
	const originalBase = svgFile.replace(/\.svg$/, "")
	const strippedBase = originalBase.replace(/-\d+$/, "")
	const base = strippedBase.length > 0 ? strippedBase : originalBase
	const parts = base.split(/[^a-zA-Z0-9]+/).filter(Boolean)
	const raw = parts.map((p) => p.charAt(0).toUpperCase() + p.slice(1)).join("")
	const safe = raw.length > 0 ? raw : "Icon"
	return `${/^[0-9]/.test(safe) ? `Icon${safe}` : safe}Icon`
}

function normalizeSvg(svgCode) {
	const normalized = svgCode
		.replace(/stroke="var\(--stroke-0,\s*[^)]+\)"/g, 'stroke="currentColor"')
		.replace(/fill="var\(--fill-0,\s*[^)]+\)"/g, 'fill="currentColor"')
		.trim()
	return `${normalized}\n`
}

async function cleanGeneratedComponents() {
	try {
		const files = await fs.readdir(SRC_COMPONENTS_DIR)
		await Promise.all(
			files
				.filter((f) => f.endsWith(".tsx"))
				.map(async (f) => {
					const filePath = path.join(SRC_COMPONENTS_DIR, f)
					const firstLine = (await fs.readFile(filePath, "utf8")).split("\n")[0]
					if (firstLine.includes(GENERATED_BANNER)) {
						await fs.unlink(filePath)
					}
				}),
		)
	} catch {
		// ignore
	}
}

async function buildIcons() {
	await fs.mkdir(SRC_COMPONENTS_DIR, { recursive: true })
	await cleanGeneratedComponents()

	const files = await fs.readdir(SRC_RAW_DIR)
	const svgFiles = files.filter((file) => file.endsWith(".svg"))

	const exportsContent = []
	const usedComponentNames = new Set()
	const typesContent = [
		`${GENERATED_BANNER}\n`,
		`import type * as React from "react"\n`,
		`export type IconProps = React.SVGProps<SVGSVGElement>;\n`,
	]

	exportsContent.push(GENERATED_BANNER)

	for (const svgFile of svgFiles) {
		const svgFilePath = path.join(SRC_RAW_DIR, svgFile)
		let componentName = toComponentName(svgFile)
		if (usedComponentNames.has(componentName)) {
			const originalBase = svgFile.replace(/\.svg$/, "")
			const originalParts = originalBase.split(/[^a-zA-Z0-9]+/).filter(Boolean)
			const originalRaw = originalParts
				.map((p) => p.charAt(0).toUpperCase() + p.slice(1))
				.join("")
			const originalSafe = originalRaw.length > 0 ? originalRaw : "Icon"
			componentName = `${/^[0-9]/.test(originalSafe) ? `Icon${originalSafe}` : originalSafe}Icon`
		}
		usedComponentNames.add(componentName)

		const svgCode = normalizeSvg(await fs.readFile(svgFilePath, "utf8"))

		const componentCode = await transform(
			svgCode,
			{
				icon: true,
				typescript: true,
				jsxRuntime: "automatic",
				plugins: ["@svgr/plugin-jsx"],
				expandProps: "end",
				svgoConfig: {
					plugins: [
						{
							name: "preset-default",
							params: {
								overrides: {
									removeViewBox: false,
								},
							},
						},
					],
				},
			},
			{ componentName },
		)

		const outputFilePath = path.join(SRC_COMPONENTS_DIR, `${componentName}.tsx`)
		await fs.writeFile(
			outputFilePath,
			`${GENERATED_BANNER}\n${componentCode}`,
			"utf8",
		)

		exportsContent.push(
			`export { default as ${componentName} } from "./components/${componentName}"`,
		)
		typesContent.push(
			`export declare const ${componentName}: (props: IconProps) => React.JSX.Element;\n`,
		)
	}

	await fs.writeFile(SRC_INDEX_FILE, `${exportsContent.join("\n")}\n`, "utf8")
	await fs.writeFile(SRC_TYPES_FILE, typesContent.join(""), "utf8")
}

buildIcons().catch((error) => {
	console.error("Error building icons:", error)
	process.exit(1)
})
